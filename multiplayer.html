<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>LinkMovie Multiplayer</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    body { font-family: system-ui, Arial, sans-serif; text-align:center; margin: 40px; }
    #countdown { font-size: 48px; margin: 20px 0; }
    #gameArea { display:none; }
    ul { list-style:none; padding:0; }
    li { margin:4px 0; }
    #overlay, #scoreboardPopup {
      position: fixed; inset: 0;
      background: rgba(0,0,0,0.85); color: #fff;
      display: flex; align-items: center; justify-content: center;
      z-index: 1000;
    }
    #scoreboardPopup { display:none; }
    .popup {
      background: #111; padding: 20px; border-radius: 10px; width: 360px;
      border: 2px solid #fff;
    }
    .small { font-size: 12px; color: #ddd; margin-top:8px; }
    .btn {
      display:inline-block; margin: 6px 4px; padding: 10px 16px; border-radius: 999px;
      border: none; cursor: pointer; font-weight: 700; color: #fff;
    }
    .btn-blue { background:#4fa7ff; }
    .btn-red { background:#e53935; }
    .btn-green { background:#2ea44f; }
    .row { display:flex; gap:18px; justify-content:center; align-items:stretch; margin: 14px 0; }
    .card {
      background:#f9f9f9; border:1px solid #ddd; border-radius: 12px; padding:12px 16px;
      text-align:left; color:#111; min-width: 260px;
    }
    .actors { display:flex; gap:14px; justify-content:center; align-items:center; }
    .actors .a { width: 120px; }
    .actors img { width:100%; border-radius: 10px; border: 2px solid #ddd; background:#f1f1f1; }
    .timer { font-weight: 800; margin-top: 6px; }
    .steps { display:inline-grid; place-items:center; width:36px; height:36px; border-radius:999px; background:#4edd00; color:#fff; font-weight:800;}
    .players li { display:flex; justify-content:space-between; align-items:center; }
    .points { background:#edcf07; color:#222121; padding:3px 8px; border-radius:999px; font-weight:800; }
    #guessLog li { padding:8px 14px; border-radius:999px; font-weight:600; margin:6px 0; }
    #guessLog li.blue { background:#4fa7ff; color:#fff; }
    #guessLog li.orange { background:#fa8b48; color:#fff; }
    #guessLog li.green { background:#4edd00; color:#fff; }
  </style>
</head>
<body>
  <!-- Header -->
  <header class="topbar">
  <img src="assets/logo.svg" alt="LinkMovie" class="logo" />
  <nav class="topbar-right">
    <!-- Game group (right) -->
    <a href="index.html" class="nav-pill">Link Movie</a>
    <a href="actor-chain.html" class="nav-pill">Link Actor</a>
    <a href="multiplayer.html" class="nav-pill is-active">Multiplayer</a>

    <img src="assets/help-icon.svg" alt="Help" class="help-icon"
         onclick="document.getElementById('mpHelp')?.classList.add('visible')" />
  </nav>
</header>

  <h1>Multiplayer</h1>

  <div id="overlay">
    <div class="popup">
      <h2 id="overlayTitle">Joining Lobby‚Ä¶</h2>
      <div id="countdown">‚Äî</div>
      <div class="small" id="overlayMsg">Setting things up</div>
    </div>
  </div>

  <div id="scoreboardPopup">
    <div class="popup">
      <h2 id="scoreboardTitle">Round Over</h2>
      <ul id="scoreList"></ul>
      <div id="scoreCountdown" class="small">Next round starts shortly‚Ä¶</div>
      <p id="winnerLine" style="display:none; font-weight:800; margin-top:8px;"></p>
      <button id="playAgainBtn" class="btn btn-blue" style="display:none;">üîÅ Play Again</button>
    </div>
  </div>

  <div id="gameArea">
    <div class="row">
      <div class="card" style="text-align:center">
        <div class="actors">
          <div class="a">
            <img id="actor1Img" alt="Start Actor">
            <div id="actor1" style="font-weight:800; margin-top:6px;">‚Äî</div>
          </div>
          <div class="a">
            <img id="actor2Img" alt="Target Actor">
            <div id="actor2" style="font-weight:800; margin-top:6px;">‚Äî</div>
          </div>
        </div>
        <div class="timer" id="roundTimer">03:00</div>
      </div>

      <div class="card" style="min-width: 320px;">
        <h3 style="margin:6px 0 10px;">Current Chain</h3>
        <ul id="guessLog"></ul>
        <input id="guessInput" placeholder="Enter a movie..." autocomplete="off" style="width:100%; padding:10px; border:1px solid #ccc; border-radius:10px;">
        <div id="suggestions" style="display:none; text-align:left; border:1px solid #eee; background:#fff; border-radius:10px; margin-top:6px;"></div>
        <div style="margin-top:10px; text-align:center;">
          <button id="submitGuess" class="btn btn-blue">Submit</button>
          <button id="resetChain" class="btn btn-red">Reset</button>
        </div>
        <div id="status" style="min-height:20px; margin-top:6px;"></div>
      </div>

      <div class="card" style="min-width: 280px;">
        <h3 style="margin:6px 0 10px;">Players</h3>
        <ul id="players" class="players"></ul>
      </div>
    </div>
  </div>

  <div id="mpHelp" style="display:none;"></div>

  <footer style="margin-top:30px; color:#666;">
    This product uses the TMDb API but is not endorsed or certified by TMDb.<br/>
    <img src="assets/tmdb-black.svg" alt="TMDb" width="90" />
  </footer>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
    import {
      getFirestore, collection, getDocs, addDoc,
      doc, setDoc, onSnapshot, updateDoc, getDoc, deleteDoc
    } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyCmRoskgYR0pjs4VIEtViohhLDcJUfk62Y",
      authDomain: "linkmovie-ef911.firebaseapp.com",
      projectId: "linkmovie-ef911",
      storageBucket: "linkmovie-ef911.appspot.com",
      messagingSenderId: "523659305871",
      appId: "1:523659305871:web:129810d281b5cf9b33a1fa",
      measurementId: "G-ZEW051T33S"
    };
    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    const TMDB_API_KEY = "455bd5e0331130bf58534b98e8c2b901";
    const IMG = "https://image.tmdb.org/t/p/w200";
    const ROUND_MS = 3 * 60 * 1000;

    const $ = (id) => document.getElementById(id);
    const username = "Player-" + Math.floor(Math.random()*10000);
    let currentLobby = null, playerRef = null, isHost = false;
    let currentStart = null, currentTarget = null;
    let lastMovieCast = []; let timerInterval = null, graceInterval = null;
    window._scheduledNext = false; window._roundEndInterval = null;

    function ms(v){ if(v==null) return 0; if(typeof v==="object"&&typeof v.toMillis==="function") return v.toMillis(); const n=Number(v); return Number.isFinite(n)?n:0; }
    function setText(id,v){ const el=$(id); if(el) el.textContent=v; }

    async function searchMovie(title){
      const r = await fetch(`https://api.themoviedb.org/3/search/movie?api_key=${TMDB_API_KEY}&query=${encodeURIComponent(title)}`);
      const d = await r.json(); return d.results || [];
    }
    async function getMovieCast(id){
      const r = await fetch(`https://api.themoviedb.org/3/movie/${id}/credits?api_key=${TMDB_API_KEY}`);
      const d = await r.json(); return d.cast || [];
    }
    async function searchPersonByName(name){
      const r = await fetch(`https://api.themoviedb.org/3/search/person?api_key=${TMDB_API_KEY}&query=${encodeURIComponent(name)}&include_adult=false`);
      const d = await r.json(); return (d.results && d.results[0]) ? d.results[0] : null;
    }
    async function pickActorByName(name){
      const p = await searchPersonByName(name);
      return p ? { id: p.id, name: p.name, profile_path: p.profile_path || "" } : { id:null, name, profile_path:"" };
    }
    async function pickRandomHydratedActor(){
      const name = ACTOR_POOL[Math.floor(Math.random()*ACTOR_POOL.length)];
      return pickActorByName(name);
    }
    async function pickAndHydrateActors(){
      let a1 = await pickRandomHydratedActor();
      let a2 = await pickRandomHydratedActor();
      while (a1.id && a2.id && a1.id === a2.id) a2 = await pickRandomHydratedActor();
      return { startActor:a1, endActor:a2 };
    }
    function setActorsOnUI(a1,a2){
      const i1 = $('actor1Img'), i2 = $('actor2Img');
      if (i1) i1.src = a1?.profile_path ? IMG + a1.profile_path : "";
      if (i2) i2.src = a2?.profile_path ? IMG + a2.profile_path : "";
      setText('actor1', a1?.name || '‚Äî'); setText('actor2', a2?.name || '‚Äî');
    }

    function startRoundCountdown(endTime){
      if (timerInterval) clearInterval(timerInterval);
      timerInterval = setInterval(()=>{
        const rem = Math.max(0, Math.ceil((endTime - Date.now())/1000));
        const m = String(Math.floor(rem/60)).padStart(2,'0');
        const s = String(rem%60).padStart(2,'0');
        setText('roundTimer', `${m}:${s}`);
        if (rem<=0){ clearInterval(timerInterval); setText('roundTimer','00:00'); }
      }, 500);
    }
    function startGraceCountdown(endTime){
      if (timerInterval) clearInterval(timerInterval);
      if (graceInterval) clearInterval(graceInterval);
      graceInterval = setInterval(()=>{
        const secs = Math.max(0, Math.ceil((endTime - Date.now())/1000));
        setText('roundTimer', `00:${String(secs).padStart(2,'0')}`);
        if (secs<=0){ clearInterval(graceInterval); setText('roundTimer','00:00'); }
      }, 500);
    }

    async function validateMovieGuess(title, isFirst){
      const results = await searchMovie(title);
      if (!results.length) return { valid:false, reason:"Movie not found" };
      const movie = results[0];
      const cast = await getMovieCast(movie.id);

      if (isFirst){
        const ok = cast.some(a => a.name === (currentStart?.name));
        if (!ok) return { valid:false, reason:"Must include start actor" };
      } else {
        const overlap = cast.some(a => lastMovieCast.some(b => b.id === a.id));
        if (!overlap) return { valid:false, reason:"Must connect with previous movie" };
      }
      lastMovieCast = cast;
      const reachedTarget = cast.some(a => a.name === (currentTarget?.name));
      return { valid:true, reachedTarget, movieTitle: movie.title };
    }

    async function resetAllPlayerSteps(lobbyId){
      const ps = await getDocs(collection(db,'lobbies',lobbyId,'players'));
      await Promise.all(ps.docs.map(d => updateDoc(doc(db,'lobbies',lobbyId,'players',d.id), { steps:0 })));
    }

    async function joinLobby(){
      const snaps = await getDocs(collection(db,'lobbies'));
      let chosen = null;
      for (const s of snaps.docs){
        const d = s.data();
        if (["waiting","countdown"].includes(d.status)){
          const ps = await getDocs(collection(db,'lobbies',s.id,'players'));
          if (ps.size < 4 && ps.size > 0){ chosen = s; break; }
        }
      }
      if (chosen){
        currentLobby = chosen.id;
        playerRef = doc(db,'lobbies',currentLobby,'players',username);
        await setDoc(playerRef, { name:username, steps:0, score:0 });
        watchLobby();
      } else {
        const ref = await addDoc(collection(db,'lobbies'), { status:'waiting', createdAt:Date.now(), round:0 });
        currentLobby = ref.id;
        playerRef = doc(db,'lobbies',currentLobby,'players',username);
        await setDoc(playerRef, { name:username, steps:0, score:0 });
        watchLobby();
      }
    }

    function watchLobby(){
      const lobbyRef = doc(db,'lobbies',currentLobby);

      onSnapshot(lobbyRef, async (snap)=>{
        if (!snap.exists()) return;
        const data = snap.data();

        if (data.status === 'countdown' && data.countdownEndsAt){
          document.getElementById('overlay').style.display='flex';
          document.getElementById('scoreboardPopup').style.display='none';
          startCountdown(ms(data.countdownEndsAt));
        }

        if (data.status === 'playing'){
          document.getElementById('overlay').style.display='none';
          document.getElementById('scoreboardPopup').style.display='none';
          document.getElementById('gameArea').style.display='block';

          currentStart = data.startActor; currentTarget = data.endActor;
          setActorsOnUI(currentStart, currentTarget);
          document.getElementById('guessLog').innerHTML = "";
          lastMovieCast = [];

          const endMs = ms(data.roundEndsAt) || (ms(data.startTime) + ROUND_MS);
          startRoundCountdown(endMs);

          if (isHost && endMs){
            if (window._roundEndInterval) clearInterval(window._roundEndInterval);
            window._roundEndInterval = setInterval(async ()=>{
              if (Date.now() > endMs){
                clearInterval(window._roundEndInterval); window._roundEndInterval=null;
                const latest = await getDoc(lobbyRef);
                if (latest.exists() && latest.data().status === 'playing'){
                  await updateDoc(lobbyRef, { status:'postRound', postRoundEndsAt: Date.now()+10000 });
                }
              }
            }, 500);
          }
        }

        if (data.status === 'grace'){
          startGraceCountdown(data.graceEndsAt);
          if (isHost && data.graceEndsAt){
            const t = setInterval(async ()=>{
              if (Date.now() > data.graceEndsAt){
                clearInterval(t);
                await updateDoc(lobbyRef, { status:'postRound', postRoundEndsAt: Date.now()+10000 });
              }
            }, 500);
          }
        }

        if (data.status === 'postRound'){
          document.getElementById('gameArea').style.display='none';
          document.getElementById('overlay').style.display='none';
          document.getElementById('scoreboardPopup').style.display='flex';

          if (data.round >= 3){
            await showFinalScores();
            if (isHost) await updateDoc(lobbyRef, { status:'final' });
          } else {
            const endMs = ms(data.postRoundEndsAt);
            await showScoreboard(endMs);

            if (isHost && endMs){
              const msLeft = Math.max(0, endMs - Date.now());
              if (!window._scheduledNext){
                window._scheduledNext = true;
                setTimeout(async ()=>{
                  const snap2 = await getDoc(lobbyRef);
                  const d2 = snap2.data();
                  if (d2.round < 3){
                    const nextRound = d2.round + 1;
                    await resetAllPlayerSteps(currentLobby);
                    const actors = await pickAndHydrateActors();
                    await updateDoc(lobbyRef, {
                      status:'playing',
                      round: nextRound,
                      startTime: Date.now(),
                      roundEndsAt: Date.now() + ROUND_MS,
                      winner:"",
                      winnerPoints:0,
                      finishers:[],
                      ...actors
                    });
                  }
                  window._scheduledNext=false;
                }, msLeft || 100);
              }
            }
          }
        }

        if (data.status === 'final'){
          document.getElementById('gameArea').style.display='none';
          document.getElementById('overlay').style.display='none';
          document.getElementById('scoreboardPopup').style.display='flex';
          await showFinalScores();
          window._scheduledNext=false;
        }
      });

      const playersRef = collection(db,'lobbies',currentLobby,'players');
      onSnapshot(playersRef, async (ps)=>{
        const names=[]; ps.forEach(d=>names.push(d.id)); names.sort();
        isHost = (names[0] === username);

        const ul=$('players'); ul.innerHTML="";
        ps.forEach(d=>{
          const p=d.data();
          const li=document.createElement('li');
          li.innerHTML = `
            <span style="display:inline-block;background:#2f2f2f;color:#fff;padding:3px 10px;border-radius:999px;font-weight:800;font-size:12px;line-height:1;">${p.name}</span>
            <span class="steps" title="Steps">${p.steps||0}</span>
            <span class="points" title="Points">${p.score||0} pts</span>`;
          ul.appendChild(li);
        });

        if (isHost && ps.size >= 2){
          const lobbyRef = doc(db,'lobbies',currentLobby);
          const lobbySnap = await getDoc(lobbyRef);
          const data = lobbySnap.data();
          if (data.status === 'waiting'){
            await updateDoc(lobbyRef, {
              status:'countdown',
              countdownEndsAt: Date.now() + 10000,
              round: 1,
              ...(await pickAndHydrateActors())
            });
          }
        }

        if (ps.size===0){
          const lobbyRef = doc(db,'lobbies',currentLobby);
          await deleteDoc(lobbyRef);
        }
      });
    }

    function startCountdown(endTime){
      const iv = setInterval(async ()=>{
        const secs = Math.max(0, Math.ceil((endTime - Date.now())/1000));
        setText('countdown', secs);
        if (secs<=0){
          clearInterval(iv);
          setText('countdown','');
          document.getElementById('overlay').style.display='none';
          if (isHost){
            const lobbyRef = doc(db,'lobbies',currentLobby);
            const snap = await getDoc(lobbyRef);
            const curRound = (snap.data()?.round)||1;
            const actors = await pickAndHydrateActors();
            await updateDoc(lobbyRef,{
              status:'playing',
              round: curRound,
              startTime: Date.now(),
              roundEndsAt: Date.now() + ROUND_MS,
              ...actors
            });
          }
        }
      }, 200);
    }

    async function showScoreboard(endTime){
      const ps = await getDocs(collection(db,'lobbies',currentLobby,'players'));
      const arr = ps.docs.map(d=>d.data()).sort((a,b)=>(b.score||0)-(a.score||0));
      document.getElementById('scoreList').innerHTML = arr.map((p,i)=>{
        return `<li><strong>${i+1}.</strong> <span style="display:inline-block;background:#2f2f2f;color:#fff;padding:3px 10px;border-radius:999px;font-weight:800;font-size:12px;line-height:1;">${p.name}</span> <span class="points">${p.score||0} pts</span></li>`;
      }).join('');
      document.getElementById('winnerLine').style.display='none';
      document.getElementById('playAgainBtn').style.display='none';
      document.getElementById('scoreboardTitle').textContent='Round Over';

      const iv = setInterval(()=>{
        const secs = Math.max(0, Math.ceil((endTime - Date.now())/1000));
        document.getElementById('scoreCountdown').textContent = `Next round in ${secs}s`;
        if (secs<=0) clearInterval(iv);
      }, 500);
    }

    async function showFinalScores(){
      const ps = await getDocs(collection(db,'lobbies',currentLobby,'players'));
      const arr = ps.docs.map(d=>d.data()).sort((a,b)=>(b.score||0)-(a.score||0));
      document.getElementById('scoreList').innerHTML = arr.map((p,i)=>{
        return `<li><strong>${i+1}.</strong> <span style="display:inline-block;background:#2f2f2f;color:#fff;padding:3px 10px;border-radius:999px;font-weight:800;font-size:12px;line-height:1;">${p.name}</span> <span class="points">${p.score||0} pts</span></li>`;
      }).join('');

      const winner = arr[0];
      if (winner){
        document.getElementById('winnerLine').style.display='block';
        document.getElementById('winnerLine').textContent = `üèÜ Winner: ${winner.name} ‚Äî ${winner.score||0} pts`;
      }
      document.getElementById('scoreboardTitle').textContent='Final Scores';
      document.getElementById('scoreCountdown').textContent='üèÅ Game Over';
      document.getElementById('playAgainBtn').style.display = 'inline-block';
    }

    window.addEventListener('beforeunload', async ()=>{ if (playerRef) await deleteDoc(playerRef); });

    document.getElementById('submitGuess').addEventListener('click', async ()=>{
      const guess = document.getElementById('guessInput').value.trim(); if (!guess) return;
      const snap = await getDoc(playerRef); const me = snap.data();
      const isFirst = (me.steps||0)===0;
      const result = await validateMovieGuess(guess, isFirst);
      if (!result.valid){ alert("‚ùå "+result.reason); return; }

      const newSteps = (me.steps||0)+1; await updateDoc(playerRef,{ steps:newSteps });

      const li = document.createElement('li');
      li.className = isFirst ? 'blue' : 'orange';
      li.textContent = result.movieTitle;
      document.getElementById('guessLog').appendChild(li);

      const lobbyRef = doc(db,'lobbies',currentLobby);
      const lobbySnap = await getDoc(lobbyRef); const lobbyData = lobbySnap.data();

      if (result.reachedTarget){
        li.className = 'green';
        const elapsedSecs = Math.floor((Date.now() - lobbyData.startTime)/1000);
        const pts = Math.max(10, 100 - newSteps*10 - Math.floor(elapsedSecs/10));
        const newScore = (me.score||0) + pts; await updateDoc(playerRef,{ score:newScore });

        let finishers = lobbyData.finishers || [];
        if (!finishers.find(f=>f.name===username)) finishers.push({ name:username, points:pts });

        if (newScore >= 200){
          await updateDoc(lobbyRef, { winner: username, winnerPoints: newScore, finishers, status:'final' });
          return;
        }

        if (!lobbyData.winner){
          await updateDoc(lobbyRef, {
            winner: username,
            winnerPoints: pts,
            finishers,
            status:'grace',
            graceEndsAt: Date.now()+10000
          });
        } else {
          await updateDoc(lobbyRef, { finishers });
        }
      }

      document.getElementById('guessInput').value=""; document.getElementById('suggestions').style.display='none';
    });

    document.getElementById('resetChain').addEventListener('click', async ()=>{
      document.getElementById('guessLog').innerHTML = "";
      lastMovieCast = [];
      try {
        if (playerRef) await updateDoc(playerRef, { steps: 0 });
      } catch {}
    });

    document.getElementById('guessInput').addEventListener('input', async (e)=>{
      const q = e.target.value.trim(); const box = document.getElementById('suggestions'); box.innerHTML="";
      if (q.length < 2) { box.style.display = "none"; return; }
      const results = await searchMovie(q);
      results.slice(0, 5).forEach(movie => {
        const div = document.createElement("div"); div.textContent = movie.title;
        div.onclick = () => { $('guessInput').value = movie.title; box.style.display = "none"; };
        box.appendChild(div);
      });
      box.style.display = results.length ? "block" : "none";
    });

    joinLobby();
  </script>
</body>
</html>
