<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>LinkMovie Multiplayer Auto</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    body { font-family: system-ui, Arial, sans-serif; text-align:center; margin: 40px; }
    #countdown { font-size: 48px; margin: 20px 0; }
  </style>
</head>
<body>
  <h1>🎬 LinkMovie Multiplayer</h1>
  <p id="status">Joining lobby...</p>
  <div id="countdown"></div>
  <ul id="players"></ul>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
    import {
      getFirestore, collection, query, where, getDocs, addDoc,
      doc, setDoc, onSnapshot, updateDoc, serverTimestamp,
      deleteDoc
    } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyCmRoskgYR0pjs4VIEtViohhLDcJUfk62Y",
      authDomain: "linkmovie-ef911.firebaseapp.com",
      projectId: "linkmovie-ef911",
      storageBucket: "linkmovie-ef911.appspot.com",
      messagingSenderId: "523659305871",
      appId: "1:523659305871:web:129810d281b5cf9b33a1fa",
      measurementId: "G-ZEW051T33S"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const $ = (id) => document.getElementById(id);

    // --- Random username
    const username = "Player-" + Math.floor(Math.random() * 10000);

    let currentLobby = null;
    let playerRef = null;

    // --- Auto join or create lobby
    async function joinLobby() {
      $('status').textContent = `Hello ${username}, searching for lobby...`;

      // look for waiting lobby with <4 players
      const q = query(collection(db, "lobbies"), where("status", "==", "waiting"));
      const snaps = await getDocs(q);

      if (!snaps.empty) {
        const lobby = snaps.docs[0];
        currentLobby = lobby.id;
        playerRef = doc(db, "lobbies", currentLobby, "players", username);
        await setDoc(playerRef, { name: username });
        $('status').textContent = `Joined lobby ${currentLobby}`;
        watchLobby();
      } else {
        // create new lobby
        const ref = await addDoc(collection(db, "lobbies"), {
          status: "waiting",
          createdAt: Date.now()
        });
        currentLobby = ref.id;
        playerRef = doc(db, "lobbies", currentLobby, "players", username);
        await setDoc(playerRef, { name: username });
        $('status').textContent = `Created lobby ${currentLobby}, waiting for players...`;
        watchLobby();
      }
    }

    // --- Watch lobby updates
    function watchLobby() {
      const lobbyRef = doc(db, "lobbies", currentLobby);

      onSnapshot(lobbyRef, (snap) => {
        if (!snap.exists()) return;
        const data = snap.data();
        console.log("📡 Lobby update:", data);

        if (data.status === "countdown" && data.countdownEndsAt) {
          startCountdown(data.countdownEndsAt.toMillis());
        }
      });

      const playersRef = collection(db, "lobbies", currentLobby, "players");
      onSnapshot(playersRef, async (snap) => {
        const ul = $('players');
        ul.innerHTML = "";
        snap.forEach(d => {
          const li = document.createElement("li");
          li.textContent = d.id;
          ul.appendChild(li);
        });

        const playerCount = snap.size;

        // If lobby has at least 2 players and still waiting, start 10s join window
        const lobbySnap = await getDocs(query(collection(db, "lobbies")));
        if (playerCount >= 2) {
          const lobbyData = snap.docs[0];
          const lobbyRef = doc(db, "lobbies", currentLobby);
          const lobbyDocSnap = await getDocs(query(collection(db, "lobbies")));
          await updateDoc(lobbyRef, {
            status: "countdown",
            countdownEndsAt: new Date(Date.now() + 10000) // start 10s window
          });
        }

        // If no players remain, delete lobby
        if (playerCount === 0) {
          await deleteDoc(lobbyRef);
          console.log("🗑 Lobby deleted (no players left):", currentLobby);
        }
      });
    }

    // --- 5-second countdown before round
    function startCountdown(endTime) {
      const interval = setInterval(() => {
        const now = Date.now();
        const secs = Math.max(0, Math.ceil((endTime - now) / 1000));
        $('countdown').textContent = secs;
        if (secs <= 0) {
          clearInterval(interval);
          $('status').textContent = "▶️ Round started!";
          $('countdown').textContent = "";
        }
      }, 200);
    }

    // --- Cleanup on exit
    window.addEventListener("beforeunload", async () => {
      if (playerRef) {
        await deleteDoc(playerRef);
      }
    });

    joinLobby();
  </script>
</body>
</html>
