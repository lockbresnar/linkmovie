<div class="card" id="game">
  <p>Lobby ID: <code id="lobbyCode"></code></p>
  <p>Status: <span id="lobbyStatus"></span></p>
  <p>Round: <span id="roundNumber">0</span> / 5</p>
  <p>Target: <span id="targetActors">-</span></p>
  <div class="row">
    <button id="submitAnswer">Submit Answer (Test)</button>
  </div>
  <h3>Players</h3>
  <ul id="playersList"></ul>
</div>

<!-- Winner Popup -->
<div id="winnerPopup" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.8); color:#fff; display:flex; align-items:center; justify-content:center; flex-direction:column; z-index:1000;">
  <h2 id="winnerText"></h2>
  <button onclick="window.location.reload()">Play Again</button>
</div>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
  import {
    getFirestore, collection, doc, setDoc, addDoc, updateDoc, increment,
    onSnapshot, query, where, getDocs, getDoc
  } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

  const firebaseConfig = {
    apiKey: "AIzaSyCmRoskgYR0pjs4VIEtViohhLDcJUfk62Y",
    authDomain: "linkmovie-ef911.firebaseapp.com",
    projectId: "linkmovie-ef911",
    storageBucket: "linkmovie-ef911.firebasestorage.app",
    messagingSenderId: "523659305871",
    appId: "1:523659305871:web:129810d281b5cf9b33a1fa",
    measurementId: "G-ZEW051T33S"
  };

  const app = initializeApp(firebaseConfig);
  const db = getFirestore(app);

  const $ = (id) => document.getElementById(id);
  let currentLobby = null;
  let currentPlayer = null;
  let roundTimer = null;

  // --- START GAME ---
  function startGame(lobbyId, type) {
    $('setup').style.display = "none";
    $('game').style.display = "block";
    $('lobbyCode').textContent = lobbyId;
    $('lobbyStatus').textContent = type === "public" ? "Public (Quick Play)" : "Private (Invite Only)";

    const lobbyRef = doc(db, "lobbies", lobbyId);

    // Watch lobby rounds
    onSnapshot(lobbyRef, (snap) => {
      if (!snap.exists()) return;
      const data = snap.data();
      $('roundNumber').textContent = data.round || 0;
      $('targetActors').textContent = data.target || "-";

      if (data.winner) {
        showWinner(data.winner, data.finalScores || {});
      }
    });

    // Watch players
    const playersRef = collection(db, "lobbies", lobbyId, "players");
    onSnapshot(playersRef, (snap) => {
      const ul = $('playersList');
      ul.innerHTML = "";
      snap.forEach((d) => {
        const p = d.data();
        const li = document.createElement("li");
        li.textContent = `${p.name} ‚Äî Steps: ${p.steps} | Score: ${p.score}`;
        ul.appendChild(li);
      });
    });
  }

  // --- SUBMIT ANSWER (simulate win) ---
  $('submitAnswer').onclick = async () => {
    if (!currentLobby || !currentPlayer) return;
    const lobbyRef = doc(db, "lobbies", currentLobby);
    const lobbySnap = await getDoc(lobbyRef);
    if (!lobbySnap.exists()) return;
    const lobby = lobbySnap.data();

    // if round already resolved, ignore
    if (lobby.roundResolved) return;

    // Give points (100 for now)
    const playerRef = doc(db, "lobbies", currentLobby, "players", currentPlayer);
    await updateDoc(playerRef, { score: increment(100) });

    // Mark round as resolved + start 10s timer
    await updateDoc(lobbyRef, { roundResolved: true });

    if (roundTimer) clearTimeout(roundTimer);
    roundTimer = setTimeout(() => endRound(currentLobby), 10000);
  };

  // --- END ROUND ---
  async function endRound(lobbyId) {
    const lobbyRef = doc(db, "lobbies", lobbyId);
    const lobbySnap = await getDoc(lobbyRef);
    if (!lobbySnap.exists()) return;
    const lobby = lobbySnap.data();

    const round = (lobby.round || 1);
    if (round >= 5) {
      // Game over
      const playersSnap = await getDocs(collection(db, "lobbies", lobbyId, "players"));
      const scores = {};
      let topPlayer = null, topScore = -1;
      playersSnap.forEach((d) => {
        const p = d.data();
        scores[p.name] = p.score;
        if (p.score > topScore) { topScore = p.score; topPlayer = p.name; }
      });
      await updateDoc(lobbyRef, { winner: topPlayer, finalScores: scores });
    } else {
      // Next round
      const actors = getRandomActors();
      await updateDoc(lobbyRef, {
        round: round + 1,
        target: actors,
        roundResolved: false
      });
    }
  }

  // --- SHOW WINNER ---
  function showWinner(name, scores) {
    $('winnerPopup').style.display = "flex";
    $('winnerText').textContent = `üèÜ Winner: ${name} (${JSON.stringify(scores)})`;
  }

  // --- Helper: random actors (placeholder) ---
  function getRandomActors() {
    const actors = ["Tom Hanks", "Meryl Streep", "Brad Pitt", "Emma Stone", "Denzel Washington"];
    const a = actors[Math.floor(Math.random() * actors.length)];
    const b = actors[Math.floor(Math.random() * actors.length)];
    return `${a} ‚Üí ${b}`;
  }

  // --- Auto-Join from URL ---
  const params = new URLSearchParams(window.location.search);
  const lobbyParam = params.get("lobby");
  const nameParam = params.get("name");
  if (lobbyParam && nameParam) {
    currentLobby = lobbyParam;
    currentPlayer = nameParam;
    startGame(lobbyParam, "public"); // type can be fetched later
  }
</script>
